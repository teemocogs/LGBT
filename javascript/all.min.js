var $userimage=$("#userimage .inner"),$coverimage=$("#coverimage .inner"),$dragger=$("#dragger"),$sizer=$("#size-slider"),$loading=$("#loading");$uploading=$("#uploading");$(window).load(function(){var a=$userimage.width(),b=getImgSize(getBackgroundImage($userimage));resizeDragger(b,a)});
$(document).ready(function(){$("body").iealert({support:"ie9",title:"\u60a8\u7684\u700f\u89bd\u5668\u592a\u820a\u5566\uff01",text:"\u8acb\u66f4\u65b0\u60a8\u7684\u700f\u89bd\u5668\uff0c\u6211\u5011\u63a8\u85a6\u60a8\u4f7f\u7528 Google Chrome",closeBtn:!1,upgradeTitle:"\u4e0b\u8f09 Google Chrome",upgradeLink:"http://www.google.com/chrome/"});$dragger.draggable({drag:function(a){$userimage.css("background-position",$dragger.css("left")+" "+$dragger.css("top"));0==$userimage.hasClass("dragged")&&$userimage.addClass("dragged");
a=$("input[name=template]:checked").val();9!=a&&10!=a||$userimage.attr("class","inner")}});$sizer.slider({value:100,max:170,min:30,slide:function(a,b){var e=getBackgroundSize($userimage.css("background-size")),d=getBackgroundPosition($userimage.css("background-position")),c=getBackgroundCenterPoint(e,d);$("<img/>").attr("src",getBackgroundImage($userimage)).load(function(){var a=[this.width,this.height],d=a[0]*b.value/100,a=a[1]*b.value/100,e=c[0]-.5*d,l=c[1]-.5*a;$dragger.css("width",d+"px").css("height",
a+"px").css("top",l+"px").css("left",e+"px");$userimage.css("background-size",d+"px "+a+"px").css("background-position",e+"px "+l+"px")})}});$("body").delegate("input[name=template]","change",function(){var a=$(this).val();$coverimage.css("background-image","url("+("images/object/"+a+".png")+")");1==$userimage.hasClass("dragged")?$userimage.attr("class","inner dragged"):$userimage.attr("class","inner");$("<img/>").attr("src",getBackgroundImage($userimage)).load(function(){var b=[this.width,this.height],
e=$userimage.width();resizeDragger(b,e,a)})});$("#normalSubmit").click(function(){var a=$userimage.width(),b=getBackgroundSize($userimage.css("background-size")),e=getBackgroundPosition($userimage.css("background-position")),a=a/500,d=$("input[name=template]:checked").val(),c=$("#source").val();createImage(d,c,e[0]/a,e[1]/a,b[0]/a,b[1]/a)})});$(window).konami({code:[55,55,55],cheat:function(){$(".banana").slideDown()}});
$(window).konami({code:[54,54,54],cheat:function(){$("h1,#size-slider").delay(100).animate({opacity:"0"},2900);$("#formbuttons,.template-label").delay(400).animate({opacity:"0"},2600);$("#settings").delay(1E3).animate({opacity:"0"},2E3);$(".left-bottom-corner").delay(800).animate({opacity:"0"},2200);$(".preview").animate({top:"-500px",opacity:"0.5"},3E3).animate({width:"0",opacity:"0"},3E3,function(){$("#content").slideUp()})}});
function createImage(a,b,e,d,c,g){var f=new Image;f.src="images/object/"+a+".png";a=new Image;a.src=b;b=document.getElementById("result");b.width=500;b.height=500;var h=b.getContext("2d");h.rect(0,0,500,500);h.fillStyle="#CCCCCC";h.fill();h.drawImage(a,e,d,c,g);h.drawImage(f,0,0,500,500);e=b.toDataURL("image/png");0<window.navigator.userAgent.indexOf("MSIE ")||navigator.userAgent.match(/Trident.*rv\:11\./)?(e="<p>\u8acb\u6309\u53f3\u9375\u53e6\u5b58\u5716\u7247</p>"+("<img src='"+e+"' alt='7'/>"),
window.open().document.write(e)):($("#download").attr("href",e),$("#download")[0].click())}$(function(){var a=document.getElementById("drop");a.addEventListener("dragover",handleDragOver,!1);a.addEventListener("drop",handleFileSelect,!1);$(".uploadBtn").click(function(){$("#uploadInput").click()});$("#uploadInput").on("change",function(){input=document.getElementById("uploadInput");loadImage(input.files)})});
function handleFileSelect(a){a.stopPropagation();a.preventDefault();loadImage(a.dataTransfer.files)}function handleDragOver(a){a.stopPropagation();a.preventDefault();a.dataTransfer.dropEffect="copy"}
function loadImage(a){function b(){c=new Image;c.onload=e;c.src=d.result}function e(){var a=document.getElementById("canvas");a.width=c.width;a.height=c.height;var b=a.getContext("2d");b.drawImage(c,0,0);a=a.toDataURL("image/png");$("#source").attr("value",a);$userimage.css("background-image","url("+a+")");var d=document.getElementById("thumb"),e,k;c.width>c.height?(k=100,e=c.width/c.height*100):(e=100,k=c.height/c.width*100);d.width=e;d.height=k;b=d.getContext("2d");b.drawImage(c,0,0,e,k);b=d.toDataURL("image/png");
$("#templates label").css("background-image","url("+b+")");$("<img/>").attr("src",a).load(function(){var a=$("input[name=template]:checked").val(),b=$userimage.width();resizeDragger([this.width,this.height],b,a);$loading.hide();$uploading.fadeOut()})}var d,c;a?($uploading.fadeIn(),$loading.show(),a=a[0],d=new FileReader,d.onload=b,d.readAsDataURL(a)):alert("\u60b2\u5287\uff01\u60a8\u7684\u700f\u89bd\u5668\u4e0d\u652f\u63f4\u6a94\u6848\u4e0a\u50b3\uff01")}
function getImgSize(a){var b=new Image;b.src=a;return[b.width,b.height]}function getBackgroundImage(a){return a.css("background-image").replace(/^url\(["']?/,"").replace(/["']?\)$/,"")}
function resizeDragger(a,b,e,d){e="undefined"!==typeof e?e:1;var c,g,f;a[0]>a[1]?(c=b/a[1],d=a[0]*c,c=b,g=0,f=-.5*(d-b)):(c=b/a[0],d=b,c*=a[1],g=-.5*(c-b),f=0);6==e?(f=-.2*b,a[0]>a[1]&&(f-=.5*(d-b))):9==e?($sizer.slider("value",65),f=.04225*b,d*=.65,c*=.65,g=.48*(b-c)):10==e&&($sizer.slider("value",92),a[0]>a[1]?(d=.92*b,c=a[1]/a[0]*d):(d*=.92,c*=.92),g=.045*b,f=.5*(b-d));$dragger.css("width",d+"px").css("height",c+"px").css("top",g+"px").css("left",f+"px");$userimage.css("background-size",d+"px "+
c+"px").css("background-position",f+"px "+g+"px")}function getBackgroundSize(a){size=a.split(" ");return[px2int(size[0]),px2int(size[1])]}function getBackgroundPosition(a){position=a.split(" ");return[px2int(position[0]),px2int(position[1])]}function getBackgroundCenterPoint(a,b){return[.5*a[0]+b[0],.5*a[1]+b[1]]}function px2int(a){return parseFloat(a.replace("px",""))};
